# CLAUDE.md — LeanDeep Annotator

## Project Overview

LeanDeep 5.0 marker detection engine for psychological/conversational pattern analysis. Four-layer hierarchy: **ATO** (atomic regex signals) → **SEM** (semantic blends) → **CLU** (cluster intuitions) → **MEMA** (meta markers). Pure Python, no LLM dependency. ~850 markers, regex-based detection with VAD emotion tracking, episode detection, and persona profiling.

## Directory Layout

```
api/                    # FastAPI application
  main.py               # Endpoints (analyze, dynamics, personas, markers)
  engine.py             # 4-layer detection engine with VAD congruence gate
  models.py             # Pydantic request/response models
  personas.py           # Persona Profile System (Pro tier, YAML persistence)
  dynamics.py           # UED metrics + state indices computation
  prosody.py            # Prosody-based emotion scoring (6 emotions from text structure)
  config.py             # Settings (env prefix: LEANDEEP_)
  auth.py               # API key auth (disabled for dev)
  static/               # Playground + Analysis UI (HTML/JS)
build/
  markers_rated/        # Source-of-truth marker YAMLs (edit these)
    1_approved/         # Rating 1 — production quality
    2_good/             # Rating 2 — usable, needs refinement
    3_needs_work/       # Rating 3+4 — WIP/unusable
  markers_normalized/   # Generated by normalize_schema.py (DO NOT EDIT)
    marker_registry.json  # Compiled registry loaded by engine
tools/                  # Python pipeline scripts
eval/                   # Gold corpus + eval stats
tests/                  # Pytest suite
docs/                   # Architecture + theory docs
personas/               # Persona YAML profiles (gitignored, created at runtime)
```

## Quick Start

```bash
pip install -r requirements.txt
python3 -m uvicorn api.main:app --port 8420
# → http://localhost:8420/playground
# → http://localhost:8420/docs (OpenAPI)
```

## Commands

```bash
# Run API
python3 -m uvicorn api.main:app --port 8420 --reload

# Run tests
python3 -m pytest tests/ -x -q

# Pipeline: edit markers → normalize → test
python3 tools/normalize_schema.py    # Rebuild registry from markers_rated/
python3 tools/enrich_vad.py          # Add VAD + effect_on_state
python3 tools/enrich_ld5.py          # Add families, multipliers, ARS, EWMA
python3 tools/enrich_negatives.py    # Add negative examples

# Evaluation
python3 tools/eval_corpus.py         # Marker detection eval against gold corpus
python3 tools/eval_dynamics.py       # Emotion dynamics eval (VAD/UED/state trends)
```

## API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/v1/analyze` | Single text analysis (~1ms) |
| POST | `/v1/analyze/conversation` | Multi-message, all 4 layers |
| POST | `/v1/analyze/dynamics` | Full emotion dynamics + optional persona |
| POST | `/v1/personas` | Create persona profile (Pro tier) |
| GET | `/v1/personas/{token}` | Get persona profile |
| DELETE | `/v1/personas/{token}` | Delete persona |
| GET | `/v1/personas/{token}/predict` | Shift predictions |
| GET | `/v1/markers` | Filter/search markers |
| GET | `/v1/markers/{id}` | Marker detail |
| GET | `/v1/engine/config` | Engine configuration |
| GET | `/v1/health` | Health check |

## Key Architecture Rules

- **Edit source files** in `build/markers_rated/`, not `build/markers_normalized/` (normalizer overwrites)
- LD 5.0: SEM = 1 ATO + context (not ≥2 ATOs)
- Pattern type "emoji" skipped (only "regex"/"keyword" compiled)
- 3-char minimum match filter removes noise
- `context_only` tag: marker hidden from output but available for SEM composition
- VAD congruence gate: ATOs filtered by emotional field alignment (quantum collapse)
- Compositionality modulation: deterministic=1.0x, contextual=0.70x, emergent=0.50x
- ruamel.yaml for all YAML operations (preserve formatting)

## Marker YAML Conventions

- Two-space indentation, lowercase keys (uppercase for IDs only)
- IDs prefixed by layer: `ATO_*`, `SEM_*`, `CLU_*`, `MEMA_*`
- Inline short lists: `tags: [atomic, apology, text]`
- German is primary language, English patterns use `\b` word boundaries

## Commit Style

Imperative, referencing what changed: `add persona warm-start system`, `fix ATO_HESITATION false positives`.
