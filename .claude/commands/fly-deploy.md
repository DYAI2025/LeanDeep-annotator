---
description: Deploy LeanDeep API to Fly.io — build, deploy, verify health, check DNS/SSL
allowed-tools: Bash, Read, Edit, Glob
---

## Context

LeanDeep API runs on Fly.io (app name: `leandeep`, region: `fra` Frankfurt).

**Key files:**
- `Dockerfile` — Python 3.12 slim, copies api/ + markers_normalized/
- `fly.toml` — Fly config (port 8420, auto-stop, health check)
- `.dockerignore` — Excludes tests, tools, eval, docs

**Live:** https://leandeep.fly.dev (also https://leandeep.de when DNS active)
**Health:** https://leandeep.fly.dev/v1/health

## Your Task

Deploy the current state to Fly.io and verify everything works.

### Steps

1. **Pre-flight checks:**
   ```bash
   # Verify deploy files exist
   ls -la Dockerfile fly.toml .dockerignore

   # Check markers are built (engine needs these)
   ls build/markers_normalized/marker_registry.json

   # Run tests first
   python3 -m pytest tests/ -x -q
   ```

2. **Deploy:**
   ```bash
   # FLY_API_TOKEN must be set in environment
   # If not available, ask user to provide it
   fly deploy --app leandeep
   ```

3. **Verify deployment:**
   ```bash
   # Health check
   curl -s https://leandeep.fly.dev/v1/health | python3 -m json.tool

   # Quick smoke test
   curl -s -X POST https://leandeep.fly.dev/v1/analyze \
     -H "Content-Type: application/json" \
     -d '{"text": "Ich bin so muede und erschoepft", "threshold": 0.3}' \
     | python3 -m json.tool | head -30
   ```

4. **Check DNS/SSL (if leandeep.de configured):**
   ```bash
   # Check cert status
   fly certs show leandeep.de --app leandeep

   # Test domain
   curl -sI https://leandeep.de 2>/dev/null | head -5
   ```

5. **Report status:**
   - Deployment successful/failed
   - Health check response
   - Marker count from smoke test
   - DNS/SSL status

### Guardrails

- **FLY_API_TOKEN:** Needed as env var. Don't use `fly auth login` (doesn't work in Claude's shell). If token not set, ask user to provide it.
- **Tests first:** Always run pytest before deploying. Don't deploy broken code.
- **Don't rebuild markers:** The Dockerfile copies from `build/markers_normalized/`. If markers need updating, run `python3 tools/normalize_schema.py` BEFORE deploying.
- **www CNAME:** Skip www subdomain — it conflicts with A records. Only root domain matters.
- **Auto-stop:** Machines auto-stop when idle. First request after stop takes ~3s cold start. This is expected.

---
*Generated by /reflect-skills from 4 session patterns (2026-02-24)*
