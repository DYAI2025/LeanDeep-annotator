---
description: Batch-create new markers from YAML specs with validation and normalize cycle
allowed-tools: Read, Write, Edit, Bash, Glob, Grep
---

## Context
New markers are regularly added to the LeanDeep system — emotion lexicons, behavior patterns, context guards, etc. Each marker needs consistent schema, proper placement in `build/markers_rated/`, and a normalize→test cycle to validate.

## Your Task

Create one or more new markers from user-provided specs (YAML, descriptions, or pattern ideas).

### Steps

1. **Understand the marker(s)** from user input:
   - Marker ID(s) and layer (ATO/SEM/CLU/MEMA)
   - Patterns (regex/keyword)
   - Examples (positive + negative)
   - Family assignment
   - Language (de default)

2. **Validate the schema** before writing:
   ```yaml
   # Required fields for every marker:
   id: ATO_EXAMPLE_NAME          # Layer prefix + descriptive name
   schema: LeanDeep
   version: "5.1"
   layer: ATO                    # ATO | SEM | CLU | MEMA
   lang: de                      # de | en | multi
   description: "Short description"
   frame:
     signal: [keyword1, keyword2]
     concept: "what it detects"
     pragmatics: "why it matters"
     narrative: "category"
   patterns:
     - type: regex               # regex | keyword
       value: "(?i)\\b(word1|word2)\\b"
   examples:
     positive: ["Example that should match"]
     negative: ["Example that should NOT match"]
   tags: [tag1, tag2]
   rating: 1                     # 1=approved, 2=good, 3=needs work
   ```

3. **Check for duplicates**:
   ```bash
   # Search for similar existing markers
   python3 -c "
   import json
   with open('build/markers_normalized/marker_registry.json') as f:
       markers = json.load(f).get('markers', {})
   # Search by keyword in ID/description/tags
   keyword = 'SEARCH_TERM'
   for mid, m in markers.items():
       if keyword.upper() in mid or keyword.lower() in m.get('description', '').lower():
           print(f'{mid}: {m.get(\"description\", \"no desc\")}')
   "
   ```

4. **Determine target directory**:
   - Rating 1 → `build/markers_rated/1_approved/{LAYER}/`
   - Rating 2 → `build/markers_rated/2_good/{LAYER}/`
   - Verify directory exists before writing

5. **Write marker YAML files**:
   - One file per marker: `{MARKER_ID}.yaml`
   - Use ruamel.yaml conventions (double-quoted regex values for escaping)
   - German compound words: ALWAYS use `\b` word boundaries in patterns

6. **Run normalize**:
   ```bash
   python3 tools/normalize_schema.py
   ```

7. **Run tests**:
   ```bash
   python3 -m pytest tests/ -x -q
   ```

8. **Verify markers loaded**:
   ```bash
   python3 -c "
   import json
   with open('build/markers_normalized/marker_registry.json') as f:
       markers = json.load(f).get('markers', {})
   for mid in ['NEW_MARKER_ID']:
       if mid in markers:
           m = markers[mid]
           print(f'✓ {mid}: {len(m.get(\"patterns\", []))} patterns, rating {m.get(\"rating\")}')
       else:
           print(f'✗ {mid}: NOT FOUND in registry')
   "
   ```

9. **Quick smoke-test** (if API is running):
   ```bash
   curl -s -X POST http://localhost:8420/v1/analyze \
     -H "Content-Type: application/json" \
     -d '{"text": "POSITIVE_EXAMPLE_TEXT", "threshold": 0.3}' | python3 -m json.tool
   ```

### Pattern Guidelines

- **German compound words**: `\\b(halten|lieben)\\b` — prevents "beibehalten" matching
- **Case-insensitive**: Start regex with `(?i)` for German
- **Emojis**: No `\b` needed (non-word chars provide natural boundaries)
- **Umlaut handling**: Use both forms: `(ä|ae)`, `(ü|ue)`, `(ö|oe)` or Unicode escapes
- **Broad patterns** (matches common words like "I", "me"): Use `context_only` tag
- **Intensity modifiers**: Keep separate from emotion markers (design principle)

### Guardrails
- ALWAYS write to `build/markers_rated/`, NEVER to `build/markers_normalized/`
- ALWAYS run normalize + tests after creating markers
- Check for duplicate IDs before creating (registry is the source of truth for IDs)
- Minimum 3 positive + 2 negative examples per marker
- German regex must use `\b` boundaries to prevent compound word matches
- If creating SEM markers: include `composed_of` with valid ATO references
- If creating CLU markers: include `window` and `confirm_window` settings

---
*Generated by /reflect-skills from 3 session patterns*
